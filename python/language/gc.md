---
title: GC
date: 2021-3-31 17:14:00
tags: [python]
---

Python使用了三种垃圾回收机制：引用计数、标记-回收、分代回收。

### 引用计数

Python的每个对象都维护着一个变量，用来保存引用计数。

在以下情况计数增加：

+ 创建对象
+ 某个变量名（引用别名）称绑定到对象
+ 对象作为参数传参
+ 对象作为容器的元素

在以下情况计数减少：

+ 使用`del` 显式删除
+ 绑定到该对象的变量名绑定到其他对象（解绑该对象）
+ 绑定到该对象的变量名离开作用域
+ 对象作为元素从容器中移除

当引用计数减少到0时，对象会被立即回收。

优点：

+ 高效、实时
+ 易于实现

缺点：

+ 需要维护引用计数（通过GIL锁避免线程冲突）
+ 无法处理循环引用的问题

### 标记-回收

标记-回收主要是为了解决循环引用的问题，针对的是一些容器对象（list、dict、tuple、实例等等）。

每个容器对象包含一组特殊的头信息，头里面有两个指针，指向引用的容器对象，形成一个链表（零代链表）。

当分配对象的计数值与被释放对象的计数值得差值达到某个阈值时，Python会遍历链表的每个对象，减少无效引用计数，如果计数为0，回收对象。

### 分带回收

标记-回收过程中，Python检查零代链表中的对象时，如果对象没有被回收，则被移动到一代链表，同样的，一代链表的对象随后也会逐步移动到二代链表。

Python中将内存分为了3代，垃圾回收会更频繁地处理新对象（零代），当年轻代链表总数达到上限时会触发垃圾回收，回收不用的对象，不被别收的对象移动到中年代。老年代对象存活时间更长，甚至可能是内存常驻对象。